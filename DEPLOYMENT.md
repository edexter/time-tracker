# Deployment Guide - DockerHub + Render

This guide covers deploying the Time Tracker application to Render using prebuilt Docker images from DockerHub.

## Architecture Overview

- **Build**: Local builds pushed to DockerHub
- **Web Service**: Render pulls prebuilt image from DockerHub
- **Database**: Managed PostgreSQL service on Render
- **Persistent Storage**: All data stored in PostgreSQL (survives deployments)
- **SSL**: Automatic HTTPS via Render

## Deployment Workflow

```
Local development → Build Docker image → Push to DockerHub → Manual deploy on Render
```

This gives you full control over when production updates happen (no auto-deploy on git push).

## Prerequisites

1. Docker installed locally
2. DockerHub account (free tier available)
3. Render account (free tier available)
4. Generated password hash (see below)

## Step 1: Set Up DockerHub

1. Create account at https://hub.docker.com
2. Create access token:
   - Go to https://hub.docker.com/settings/security
   - Click "New Access Token"
   - Name: `time-tracker-deploy`
   - Copy the token (you won't see it again)
3. Add credentials to `.env`:
   ```bash
   DOCKERHUB_USERNAME=your-username
   DOCKERHUB_TOKEN=dckr_pat_xxxxxxxxxxxx
   ```

## Step 2: Generate Password Hash

Generate a bcrypt password hash for authentication:

```bash
python scripts/generate_password_hash.py
```

Save the generated hash - you'll need it for Render environment variables.

## Step 3: Build and Push Docker Image

### First Time Setup

Update `render.yaml` with your DockerHub username:
```yaml
image:
  url: docker.io/YOUR_USERNAME/time-tracker:latest
```

### Build and Push

```bash
# Build and push with 'latest' tag
./docker-push.sh

# Or specify a version tag
./docker-push.sh v1.0.0
```

The script will:
- Build the Docker image using `Dockerfile.prod`
- Push to DockerHub
- Display the image URL for Render

**IMPORTANT**: Always use `./docker-push.sh` for pushing to DockerHub (not manual docker commands).

## Step 4: Deploy to Render

### Option A: Using render.yaml (Recommended)

1. Go to Render Dashboard → New → Blueprint
2. Connect your GitHub repository
3. Render will detect `render.yaml` and create:
   - PostgreSQL database (`time-tracker-db`)
   - Web service (`time-tracker`) pulling from DockerHub
4. Set environment variables:
   - `PASSWORD_HASH`: Your generated bcrypt hash
   - Other variables are auto-configured

### Option B: Manual Setup

#### Create PostgreSQL Database
1. New → PostgreSQL
2. Name: `time-tracker-db`
3. Database: `timetracker`
4. User: `timetracker_user`
5. Region: Choose closest to your users
6. Plan: Starter (free) or higher
7. Create Database
8. Copy the Internal Database URL

#### Create Web Service
1. New → Web Service → Deploy an existing image
2. Image URL: `docker.io/YOUR_USERNAME/time-tracker:latest`
3. Name: `time-tracker`
4. Region: Same as database
5. Plan: Starter (free) or higher
6. Configure environment variables (see below)
7. Create Web Service

## Step 5: Environment Variables

Set these in Render Dashboard → Web Service → Environment:

| Variable | Value | Notes |
|----------|-------|-------|
| `FLASK_ENV` | `production` | Required |
| `SECRET_KEY` | (auto-generated by Render) | Or set your own strong random string |
| `PASSWORD_HASH` | `$2b$12$...` | From scripts/generate_password_hash.py |
| `DATABASE_URL` | (from database service) | Auto-set if using render.yaml |
| `PORT` | `10000` | Default for Render |
| `WORKERS` | `4` | Gunicorn workers (adjust based on plan) |
| `THREADS` | `2` | Threads per worker |
| `TIMEOUT` | `120` | Request timeout in seconds |

## Step 6: Health Check

Render will use `/api/auth/check` endpoint to verify service health.

## Data Persistence

### Database
- PostgreSQL data is stored on Render's persistent disk
- Data survives:
  - Docker image updates
  - Service restarts
  - All deployments
- Backups:
  - Free tier: Manual backups
  - Paid tiers: Automatic daily backups

### Migrations
- Automatically run on each deployment via `start.sh`
- Migration files are part of Docker image
- Database schema evolves without data loss

## Updating the Application

### Full Workflow

1. **Develop locally**
   ```bash
   # Make changes, test locally with docker-compose
   docker-compose up
   ```

2. **Build and push when ready**
   ```bash
   # Build and push to DockerHub
   ./docker-push.sh

   # Or with version tag
   ./docker-push.sh v1.2.3
   ```

3. **Deploy to Render**
   - Go to Render Dashboard → time-tracker service
   - Click "Manual Deploy" → "Deploy latest commit"
   - Or: Update Image URL if you used a version tag
   - Render pulls new image and redeploys

4. **Database remains intact** - all user data persists

### Quick Update (No Git Commit Needed)

```bash
# Make changes
./docker-push.sh

# Deploy in Render dashboard
# Your git repo can stay as-is - no forced commits
```

## Version Management

### Using Tags

```bash
# Development builds
./docker-push.sh dev

# Release builds
./docker-push.sh v1.0.0

# Update Render to use specific version
# Image URL: docker.io/username/time-tracker:v1.0.0
```

### Latest Tag (Default)

```bash
# Always updates 'latest'
./docker-push.sh

# Render can stay pointed at 'latest' for rolling updates
```

## Rolling Back

If a deployment has issues:

1. **Quick rollback**: Push previous working image
   ```bash
   # If you have previous image locally
   docker tag username/time-tracker:v1.0.0 username/time-tracker:latest
   docker push username/time-tracker:latest

   # Manual deploy in Render
   ```

2. **Version rollback**: Change image URL in Render
   - Settings → Image URL
   - Change to previous version tag: `docker.io/username/time-tracker:v1.0.0`
   - Click "Manual Deploy"

3. **Database stays current** (migrations are forward-only)

## Monitoring

- **Logs**: Render Dashboard → Web Service → Logs
- **Metrics**: Render Dashboard → Web Service → Metrics
- **Database**: Render Dashboard → PostgreSQL → Metrics
- **DockerHub**: https://hub.docker.com/r/username/time-tracker

## Scaling

### Vertical Scaling (More Resources)
- Render Dashboard → Web Service → Settings
- Change Plan (Starter → Standard → Pro)

### Horizontal Scaling (More Instances)
- Edit `render.yaml`: Change `numInstances`
- Or: Render Dashboard → Web Service → Settings → Instances

### Database Scaling
- Render Dashboard → PostgreSQL → Settings
- Upgrade plan for more storage/connections

## Troubleshooting

### Service Won't Start
- Check Logs for errors
- Verify `DATABASE_URL` is set
- Verify `PASSWORD_HASH` is set
- Check migration errors
- Verify DockerHub image exists: `docker pull username/time-tracker:latest`

### Database Connection Errors
- Verify DATABASE_URL format
- Check database service is running
- Verify IP allowlist (should be empty for internal access)

### Image Pull Errors
- Verify DockerHub image URL is correct
- Check image exists: https://hub.docker.com/r/username/time-tracker
- For private repos: Add DockerHub credentials in Render

### Build Failures Locally
- Check Docker is running
- Verify `.env` has DOCKERHUB_USERNAME and DOCKERHUB_TOKEN
- Test build: `docker build -f Dockerfile.prod -t test .`

### Migration Failures
- Check Logs for specific error
- May need to manually fix database state
- Connect via `psql` using connection string from dashboard

## Cost Estimation

### Free Tier
- DockerHub: Free (1 private repo, unlimited public)
- Web Service: Free (750 hours/month, spins down after 15min inactivity)
- PostgreSQL: Free (1GB storage, 97 connection limit)
- **Total: $0/month**

### Starter Tier (Always On)
- DockerHub: Free
- Web Service: $7/month
- PostgreSQL: $7/month
- **Total: $14/month**

### Production Tier
- DockerHub: Free (or $5/month for more repos)
- Web Service Standard: $25/month (1 instance)
- PostgreSQL Standard: $20/month (10GB storage)
- **Total: $45-50/month**

## Security Notes

- Never commit `.env` file (contains DockerHub token)
- Rotate `DOCKERHUB_TOKEN` periodically
- Rotate `SECRET_KEY` periodically
- Use strong password hash
- Keep dependencies updated
- Monitor Render security advisories
- Monitor DockerHub for vulnerable images

## Custom Domain

1. Render Dashboard → Web Service → Settings → Custom Domain
2. Add your domain
3. Update DNS records as instructed
4. SSL certificate issued automatically

## Backup Strategy

### Automated Backups (Paid Plans)
- Daily backups (Standard+)
- 7-day retention (Standard)
- 30-day retention (Pro+)

### Manual Backups (Free Plan)
```bash
# Install PostgreSQL client
# Get connection string from Render Dashboard
pg_dump "postgresql://user:pass@host/db" > backup.sql

# Restore
psql "postgresql://user:pass@host/db" < backup.sql
```

### Docker Image Backups
- DockerHub stores all pushed images
- Use version tags to maintain history
- Pull any previous version: `docker pull username/time-tracker:v1.0.0`

## CI/CD (Optional)

If you later want automated builds:

1. Remove `workflow_dispatch` from `.github/workflows/docker-publish.yml`
2. Add GitHub secrets: `DOCKERHUB_USERNAME`, `DOCKERHUB_TOKEN`
3. Push to main → auto-builds → auto-pushes to DockerHub
4. Still requires manual deploy in Render (no auto-deploy)

## Support

- Render Documentation: https://render.com/docs
- DockerHub Documentation: https://docs.docker.com/docker-hub/
- Render Community: https://community.render.com
- Check Logs first for debugging

## Quick Reference

```bash
# Build and push
./docker-push.sh [tag]

# Local testing
docker-compose up

# View logs
docker logs time-tracker

# Connect to production database
psql "$(render env get DATABASE_URL)"
```
